import{f as U,t as $,i as K,c as L,A as k,b as q,d as p,n as B}from"./index-DEGSL-2v.js";import{s as R}from"./Guard.module-D_TDubKB.js";import{W as s,i as M,b as V,t as H,a as x,c as G,d as y,e as J}from"./toAuthenticatorAttachment-BAxCDoik.js";import{D as F}from"./fetching-DWZPZ03v.js";function W({error:e,options:i}){const{publicKey:n}=i;if(!n)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(i.signal instanceof AbortSignal)return new s({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(n.authenticatorSelection?.requireResidentKey===!0)return new s({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(i.mediation==="conditional"&&n.authenticatorSelection?.userVerification==="required")return new s({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:e});if(n.authenticatorSelection?.userVerification==="required")return new s({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new s({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new s({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return n.pubKeyCredParams.filter(l=>l.type==="public-key").length===0?new s({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new s({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const c=globalThis.location.hostname;if(M(c)){if(n.rp.id!==c)return new s({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new s({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new s({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new s({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}async function Y(e){!e.optionsJSON&&e.challenge&&(console.warn("startRegistration() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),e={optionsJSON:e});const{optionsJSON:i,useAutoRegister:n=!1}=e;if(!V())throw new Error("WebAuthn is not supported in this browser");const c={...i,challenge:x(i.challenge),user:{...i.user,id:x(i.user.id)},excludeCredentials:i.excludeCredentials?.map(H)},l={};n&&(l.mediation="conditional"),l.publicKey=c,l.signal=G.createNewAbortSignal();let o;try{o=await navigator.credentials.create(l)}catch(r){throw W({error:r,options:l})}if(!o)throw new Error("Registration was not completed");const{id:u,rawId:d,response:a,type:f}=o;let m;typeof a.getTransports=="function"&&(m=a.getTransports());let g;if(typeof a.getPublicKeyAlgorithm=="function")try{g=a.getPublicKeyAlgorithm()}catch(r){w("getPublicKeyAlgorithm()",r)}let h;if(typeof a.getPublicKey=="function")try{const r=a.getPublicKey();r!==null&&(h=y(r))}catch(r){w("getPublicKey()",r)}let b;if(typeof a.getAuthenticatorData=="function")try{b=y(a.getAuthenticatorData())}catch(r){w("getAuthenticatorData()",r)}return{id:u,rawId:y(d),response:{attestationObject:y(a.attestationObject),clientDataJSON:y(a.clientDataJSON),transports:m,publicKeyAlgorithm:g,publicKey:h,authenticatorData:b},type:f,clientExtensionResults:o.getClientExtensionResults(),authenticatorAttachment:J(o.authenticatorAttachment)}}function w(e,i){console.warn(`The browser extension that intercepted this WebAuthn API call incorrectly implemented ${e}. You should report this error to them.
`,i)}var j=$('<div><i></i><i></i><i></i><div><h2>Register</h2><p></p><div><input type=email name=email placeholder=Email* autocomplete=off autofocus required></div><div><input type=text name=username placeholder="Full Name"minlength=5 autocomplete=off required></div><div><input type=button value="Create Account"></div><div><div>');const ee=()=>{const[e,i]=U({status:!1,msg:""}),[n,c]=U(),l=async()=>{i("status",!0);const o=await fetch(`api/v1/auth/init-register?email=${n.email}&username=${n.name}`,{credentials:"same-origin"}),u=await o.json();if(!o.ok)return i({status:!1,msg:u.error});let d;try{d=await Y({optionsJSON:u})}catch(m){return m instanceof s&&m.name==="NotAllowedError"?i({status:!1,msg:"Authenticator was missing biometric verification."}):i({status:!1,msg:"Authenticator was missing biometric verification."})}const a=await F("api/v1/auth/verify-register","POST",d),f=await a.json();if(!a.ok)return i({status:!1,msg:f.error});if(!f.verified)return i({status:!1,msg:"Failed to register"});window.location.replace("/login")};return(()=>{var o=j(),u=o.firstChild,d=u.nextSibling,a=d.nextSibling,f=a.nextSibling,m=f.firstChild,g=m.nextSibling,h=g.nextSibling,b=h.firstChild,r=h.nextSibling,S=r.firstChild,E=r.nextSibling,_=E.firstChild,v=E.nextSibling;return v.firstChild,u.style.setProperty("--clr","#0051ff"),d.style.setProperty("--clr","#fb00ff"),a.style.setProperty("--clr","#41de2f"),K(g,()=>e.msg),b.addEventListener("focus",()=>i("msg","")),b.$$input=t=>c("email",t.target.value),S.addEventListener("focus",()=>i("msg","")),S.$$input=t=>c("name",t.target.value),_.$$click=l,K(v,L(k,{href:"/login",style:{"text-align":"right"},children:"Already have an account?"}),null),q(t=>{var O=R.ring,T=R.login,A=e.status?"green":"red",P=R.inputBx,I=R.inputBx,N=R.inputBx,C=e.status,D=R.links;return O!==t.e&&p(o,t.e=O),T!==t.t&&p(f,t.t=T),A!==t.a&&((t.a=A)!=null?g.style.setProperty("color",A):g.style.removeProperty("color")),P!==t.o&&p(h,t.o=P),I!==t.i&&p(r,t.i=I),N!==t.n&&p(E,t.n=N),C!==t.s&&(_.disabled=t.s=C),D!==t.h&&p(v,t.h=D),t},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),o})()};B(["input","click"]);export{ee as default};
